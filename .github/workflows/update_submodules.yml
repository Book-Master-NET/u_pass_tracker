name: Update Submodules with Real AI Documentation using Ollama

on:
  schedule:
    - cron: "0 */20 * * *"   # cada 20 horas
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # Job 1: Setup Ollama
  setup-ollama:
    name: ğŸš€ Setup Ollama Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Ollama
        run: |
          echo "ğŸ“¦ Installing Ollama..."
          curl -fsSL https://ollama.ai/install.sh | sh
          echo "âœ… Ollama installed successfully"

      - name: Download Llama 3 model
        run: |
          echo "ğŸ”½ Downloading Llama 3 model..."
          ollama pull llama3
          echo "âœ… Model downloaded successfully"

      - name: Verify Ollama installation
        run: |
          echo "ğŸ” Verifying Ollama..."
          ollama list
          echo "âœ… Ollama verification complete"

  # Job 2: AnÃ¡lisis con Ollama
  analyze-with-ollama:
    name: ğŸ” Real AI Analysis with Ollama
    runs-on: ubuntu-latest
    needs: setup-ollama
    outputs:
      has-changes: ${{ steps.detect-changes.outputs.changes }}
      ai-documentation: ${{ steps.ollama-analysis.outputs.documentation }}
    
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Update submodules and detect changes
        id: detect-changes
        run: |
          echo "ğŸ”„ Updating submodules..."
          
          # Capturar estado antes
          git submodule status > submodule_before.txt
          
          # Actualizar submÃ³dulos
          git submodule update --remote --merge --progress
          
          # Capturar estado despuÃ©s
          git submodule status > submodule_after.txt
          
          # Detectar cambios
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            
            # Crear archivo detallado de cambios
            echo "# Detailed Submodule Changes for AI Analysis" > detailed_changes.md
            echo "Generated on: $(date)" >> detailed_changes.md
            echo "" >> detailed_changes.md
            
            for submodule in $(git diff --name-only | grep -v -E "\.(txt|md)$"); do
              if [ -d "$submodule" ]; then
                echo "## Submodule: $submodule" >> detailed_changes.md
                echo "" >> detailed_changes.md
                
                cd "$submodule"
                
                # Obtener informaciÃ³n del repositorio
                REPO_URL=$(git config --get remote.origin.url || echo "Unknown")
                CURRENT_BRANCH=$(git branch --show-current || git rev-parse --abbrev-ref HEAD || echo "detached")
                LATEST_COMMIT=$(git log -1 --oneline --pretty=format:"%h - %s (%an, %cr)")
                
                echo "- **Repository**: $REPO_URL" >> ../detailed_changes.md
                echo "- **Branch**: $CURRENT_BRANCH" >> ../detailed_changes.md
                echo "- **Latest Commit**: $LATEST_COMMIT" >> ../detailed_changes.md
                echo "" >> ../detailed_changes.md
                
                # Obtener Ãºltimos 10 commits
                echo "### Recent Commits:" >> ../detailed_changes.md
                git log --oneline -10 --pretty=format:"- \`%h\` %s (%an, %cr)" >> ../detailed_changes.md 2>/dev/null || echo "- No commit history available" >> ../detailed_changes.md
                echo "" >> ../detailed_changes.md
                
                cd ..
              fi
            done
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected" > detailed_changes.md
          fi

      - name: Generate AI Analysis Prompt
        if: steps.detect-changes.outputs.changes == 'true'
        run: |
          echo "ğŸ“ Generating AI analysis prompt..."
          
          cat > ai_prompt.txt << 'EOF'
          Eres un ingeniero de software senior especializado en anÃ¡lisis de cambios tÃ©cnicos. 
          Analiza los siguientes cambios en submÃ³dulos de Git y genera documentaciÃ³n tÃ©cnica profesional.
          
          INSTRUCCIONES ESPECÃFICAS:
          1. Analiza el impacto tÃ©cnico de los cambios
          2. Identifica posibles breaking changes
          3. EvalÃºa riesgos de integraciÃ³n
          4. Proporciona recomendaciones especÃ­ficas
          5. Genera un checklist de verificaciÃ³n tÃ©cnica
          6. Usa formato Markdown tÃ©cnico profesional
          7. Incluye secciones claras y concisas
          8. Proporciona evaluaciones de riesgo realistas
          
          CAMBIOS DETECTADOS:
          EOF
                    
                    cat detailed_changes.md >> ai_prompt.txt
                    
                    echo "" >> ai_prompt.txt
                    echo "POR FAVOR GENERA:" >> ai_prompt.txt
                    echo "- Resumen ejecutivo tÃ©cnico" >> ai_prompt.txt
                    echo "- AnÃ¡lisis de impacto detallado" >> ai_prompt.txt  
                    echo "- EvaluaciÃ³n de riesgos con niveles (BAJO/MEDIO/ALTO)" >> ai_prompt.txt
                    echo "- Recomendaciones tÃ©cnicas especÃ­ficas" >> ai_prompt.txt
                    echo "- Checklist de verificaciÃ³n pre-merge" >> ai_prompt.txt
                    echo "- Timeline estimado de revisiÃ³n" >> ai_prompt.txt

      - name: Run Real AI Analysis with Ollama
        id: ollama-analysis
        if: steps.detect-changes.outputs.changes == 'true'
        run: |
          echo "ğŸ¤– Running REAL AI analysis with Ollama..."
          
          # Ejecutar anÃ¡lisis con Ollama
          echo "ğŸš€ Starting AI analysis (this may take 2-3 minutes)..."
          
          # Usar Ollama directamente
          timeout 180s ollama run llama3 --temperature 0.1 "$(cat ai_prompt.txt)" > raw_ai_output.txt 2>&1 || \
          echo "âŒ AI analysis timed out after 3 minutes. Using fallback documentation." > raw_ai_output.txt
          
          # Limitar el tamaÃ±o del output
          if [ $(wc -c < raw_ai_output.txt) -gt 10000 ]; then
            head -c 10000 raw_ai_output.txt > raw_ai_output_trimmed.txt
            mv raw_ai_output_trimmed.txt raw_ai_output.txt
            echo "... (output truncated to 10000 characters)" >> raw_ai_output.txt
          fi
          
          # Crear documentaciÃ³n formateada
          echo "# ğŸ¤– AI-Powered Technical Analysis" > ai_documentation.md
          echo "> Generated using Ollama with Llama 3 model" >> ai_documentation.md
          echo "> Analysis timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> ai_documentation.md
          echo "" >> ai_documentation.md
          
          cat raw_ai_output.txt >> ai_documentation.md
          
          echo "" >> ai_documentation.md
          echo "---" >> ai_documentation.md
          echo "*ğŸ¤– This analysis was generated automatically using Ollama with Llama 3 model*" >> ai_documentation.md
          
          # Output para GitHub Actions
          {
            echo "documentation<<EOF"
            cat ai_documentation.md
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "âœ… REAL AI analysis completed successfully!"

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-artifacts
          path: |
            detailed_changes.md
            ai_prompt.txt
            raw_ai_output.txt
            ai_documentation.md
            submodule_before.txt
            submodule_after.txt

  # Job 3: Crear Pull Request con anÃ¡lisis AI (SOLO SI HAY CAMBIOS)
  create-ai-pr:
    name: ğŸ“‹ Create AI-Powered Pull Request
    runs-on: ubuntu-latest
    needs: analyze-with-ollama
    if: needs.analyze-with-ollama.outputs.has-changes == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-artifacts
          path: ./

      - name: Create Pull Request with AI Analysis
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update submodules with AI analysis [skip ci]"
          title: "ğŸ¤– AI-Analyzed Submodule Updates (Run #${{ github.run_number }})"
          body: |
            ${{ needs.analyze-with-ollama.outputs.ai-documentation }}
            
            ---
            
            ## ğŸ”§ Technical Details
            - **AI Provider**: Ollama with Llama 3
            - **Workflow Run**: #${{ github.run_number }}
            - **Analysis Type**: Real AI-powered technical analysis
            
            ## ğŸ“Š Analysis Summary
            - **Model**: Llama 3 (via Ollama)
            - **Integration**: Direct AI analysis of commit patterns
            
            ---
            *ğŸ¤– This analysis was generated automatically using Ollama AI integration.*
          branch: ai-update-${{ github.run_number }}
          delete-branch: true

  # Job 4: Status report
  report-status:
    name: ğŸ“Š AI Analysis Report
    runs-on: ubuntu-latest
    needs: [setup-ollama, analyze-with-ollama]
    if: always()
    
    steps:
      - name: Generate AI status report
        run: |
          echo "## ğŸ¤– AI Analysis Report"
          echo "**Run #${{ github.run_number }}** - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          echo "### ğŸš€ Ollama Setup"
          echo "Status: ${{ needs.setup-ollama.result }}"
          echo "Model: Llama 3"
          echo ""
          
          echo "### ğŸ” AI Analysis" 
          echo "Status: ${{ needs.analyze-with-ollama.result }}"
          echo "Changes Found: ${{ needs.analyze-with-ollama.outputs.has-changes }}"
          echo "AI Used: âœ… Real Ollama Integration"
          echo ""
          
          if [ "${{ needs.analyze-with-ollama.outputs.has-changes }}" == "true" ]; then
            echo "### ğŸ“‹ Pull Request"
            echo "PR Creation: Attempted (check repository settings for permissions)"
          else
            echo "### ğŸ“‹ Pull Request"
            echo "Status: Skipped (no changes detected)"
          fi

  # Job 5: Cleanup
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: report-status
    if: always()
    
    steps:
      - name: Cleanup Ollama
        run: |
          echo "ğŸ§¹ Cleaning up Ollama resources..."
          pkill ollama || true
          echo "âœ… Cleanup completed"
